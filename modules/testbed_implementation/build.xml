<project name="testbed" basedir=".">

    <!-- TODO If the directory in modules.checkoutdir does not exist,
         then running the clean target produces an error. Please let ant-scripts
         create directory if non-existent. -->
    
    <property file="build-${user.name}.properties" />

    <property file="build.properties"/>
    <target name="clean">
        <delete dir="dist"/>
        <delete dir="${modules.checkoutdir}/logappender"/>
        <delete dir="${modules.checkoutdir}/webservices"/>
        <subant target="distclean">
            <fileset dir="${modules.checkoutdir}" includes="*/build.xml"/>
        </subant>
    </target>


    <target name="getDomsServices">
        <!-- Checkout the SourceForge packages needed for building the testbed -->
        <exec executable="bash">
            <arg value="build/create_build_environment.sh"/>
            <arg value="${modules.checkoutdir}"/>
        </exec>
    </target>


    <target name="buildDomsServices" depends="getDomsServices">
        <!--Call the ant file in each of the checkouted services in the ${modules.checkoutdir}-->
        <subant target="release.bin">
            <fileset dir="${modules.checkoutdir}" includes="*/build.xml"/>
        </subant>
    </target>

    <target name="release" depends="getDomsServices, clean, buildDomsServices">
        <mkdir dir="dist"/>
        <unzip dest="${modules.checkoutdir}/webservices">
            <fileset dir="${modules.checkoutdir}" includes="*/dist/*.zip"/>
            <patternset includes="**/*.war"/>
            <flattenmapper/>
        </unzip>
        <unzip dest="${modules.checkoutdir}/logappender">
            <fileset dir="${modules.checkoutdir}" includes="*/dist/surveillance-*.zip"/>
            <patternset includes="surveillance-*/jars/*.jar"/>
            <flattenmapper/>
        </unzip>
        <!--TODO This is temporary, until buildframework generates reasonable package-->
        <copy todir="${modules.checkoutdir}/logappender">
            <fileset dir="${modules.checkoutdir}/surveillance/lib">
                <include name="*log*/jars/*.jar"/>
                <include name="*util*/jars/*.jar"/>
            </fileset>
            <flattenmapper/>
        </copy>
        <zip destfile="dist/${release}.zip">
            <zipfileset prefix="${release}" dir="${basedir}">
                <include name="config/**"/>
                <include name="docs/**"/>
                <include name="data/**"/>
            </zipfileset>
            <zipfileset prefix="${release}" dir="${basedir}" filemode="755">
                <include name="bin/**"/>
            </zipfileset>
            <zipfileset prefix="${release}/webservices" dir="${modules.checkoutdir}/webservices">
                <include name="*.war"/>
            </zipfileset>
            <zipfileset prefix="${release}/logappender" dir="${modules.checkoutdir}/logappender">
                <include name="*.jar"/>
            </zipfileset>
        </zip>
    </target>

</project>
